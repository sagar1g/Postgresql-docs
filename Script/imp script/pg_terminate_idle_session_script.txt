#!/bin/bash

# Database connection parameters
DB_USER="connection_admin"
DB_NAME="postgres"
DB_HOST="10.12.0.16"      # Set to 'localhost' if running on the same server
DB_PORT="54032"              # Default PostgreSQL port

export PGPASSWORD='uat#T3rWin@te'
# Execute the query and terminate matching idle connections
psql -U "$DB_USER" -d "$DB_NAME" -h "$DB_HOST" -p "$DB_PORT" -t -c "
SELECT terminate_backend(pid)
  FROM pg_stat_activity
  WHERE pid <> pg_backend_pid()
    AND usename = 'rep_user'
    AND state = 'idle'
    AND state_change < current_timestamp - INTERVAL '60 minutes';
"

# Check the exit status
if [ $? -eq 0 ]; then
  echo "Idle connections for user 'rep_user' terminated successfully."
else
  echo "Error terminating idle connections."
fi
