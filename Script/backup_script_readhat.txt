#!/bin/bash
#Backup Dir
#Make sure this is a dedicated mount point to PostgreSQL Backups
#Don't put traling / in path

backup_dir=/backup

CUST_ID="126110573"

PIN="5357"


#Backup Details

echo -e "\n\nBackup Status: $(date +"%d-%m-%y")" >> $backup_dir/Status.log
echo -e "-----------------------" >> $backup_dir/Status.log
echo -e "\nStart Time: $(date)\n" >> $backup_dir/Status.log
/usr/pgsql-15/bin/pg_basebackup -U postgres -p 5432 -D $backup_dir/PostgreSQL_Base_Backup_$(date +"%d-%m-%y-%H%M%S") -l "`date`" -P -Ft -R &>> $backup_dir/Status.log
echo -e "\nEnd Time: $(date)" >> $backup_dir/Status.log


if [ "$?" = "0" ]; then
        echo "Mobicule Technologies Pvt Ltd (142.79.238.170) Postgresql Backup is successful" > /data/backup_log/postgres_logfile
echo "`cat /data/backup_log/postgres_logfile`" | /data/backup_log/sendEmail -f "nttin.operations.database@global.ntt" -t "nttin.db.postgresql@global.ntt" -u "Mobicule Technologies Pvt Ltd (142.79.238.170) Postgresql Backup is successful" -s "202.87.39.93:25"


else
        echo "Mobicule Technologies Pvt Ltd (142.79.238.170) Postgresql Backup is failed" > /data/backup_log/postgres_logfile
echo "`cat /data/backup_log/postgres_logfile`" | /data/backup_log/sendEmail -f "nttin.operations.database@global.ntt" -t "nttin.db.postgresql@global.ntt" -t "svc.nttin.ngaalerts.snoc@global.ntt"  -u "Mobicule Technologies Pvt Ltd (142.79.238.170) Postgresql Backup is failed" -s "202.87.39.93:25"
fi



#Auto Deletion for Backups
#Value 2 for retention_duration will keep 3 days backups

retention_duration=7
find $backup_dir/PostgreSQL_Base_Backup* -type d -mtime +$retention_duration -exec rm -rv {} \;

