#!/bin/bash

CUST_ID="132140083"
PIN="6603"
From_email="nttin.operations.database@global.ntt"
To_email="svc.nttin.ngaalerts.snoc@global.ntt"
smtp_server="202.87.39.93"
hostname="meter_readonly_db"
IP="100.125.105.10"
#DB_PORT="5432"
# ------------------------------------------------------------------------------------------------

USER=nagios_mk
MYSQLPASSWORD='Monitoring$!23'

mkdir -p "/application/replication/monitor/monitor_DB_HOST"
outputfile="/application/replication/monitor/monitor_DB_HOST/system_details.txt"
LOCATION=/application/replication/

echo $IP

> $outputfile
#--------------------------------------------------------------------------------------------------------

##############################Replication lag ###################################################################



EMAIL=/home/infra.mg/scripts


#PostgreSQL connection parameters

PGHOST="localhost"

PGPORT="5432"

PGUSER="nagios_mk"

PGDATABASE="postgres"
#PGPORT="6412"

PG_PASSWORD='Monitoring$!23'

QUERY="SELECT EXTRACT(EPOCH FROM now() - pg_last_xact_replay_timestamp())/60 AS replication_lag_minutes;"


CRITICAL_THRESHOLD=240  # 8 hours (in minutes)


# Connect to PostgreSQL and execute the query

replication_lag_minutes=$(PGPASSWORD="$PG_PASSWORD" psql -h $PGHOST -p $PGPORT  -U $PGUSER -d $PGDATABASE -tAc "$QUERY")

#replication_lag_minutes=425.677777777777777
#echo "$replication_lag_minutes"

# Check the replication lag against thresholds

#replication= $(echo "$replication_lag_minutes >= $CRITICAL_THRESHOLD" | bc -l)

#echo = "$replication"
if [ "$(echo "$replication_lag_minutes >= $CRITICAL_THRESHOLD" | bc -l)" -eq 1 ]; then  #------------------------Ubantu Server
#if (( $(echo "$replication_lag_minutes >= $CRITICAL_THRESHOLD" | bc -l) )); then     #--------------------------centos
    echo CUST ID : $CUST_ID                                                         >> $outputfile
    echo PIN : $PIN                                                         >> $outputfile
    echo "  "                                                               >> $outputfile
    echo "Replication Break on (server ip = $IP - $hostname )"           >> $outputfile
    echo "`cat $outputfile`" | $EMAIL/sendEmail  -f "nttin.operations.database@global.ntt" -t "nttin.db.postgresql@global.ntt" -t "tech.support@clouddbtech.com" -t "karthik.vishweshwara@bcits.in" -t "vishwas.srinivas@bcits.in" -t "pgvcl-ntt-monitoring@bcits.co.in" -t "$To_email" -u "CUST ID : $CUST_ID|| Replication Break on Server $IP / $hostname" -s "202.87.39.93:25"

# echo "`cat $outputfile`" | $EMAIL/sendEmail  -f "nttin.operations.database@global.ntt"  -t "tech.support@clouddbtech.com"  -u "CUST ID : $CUST_ID|| Replication Break on Server $IP / $hostname" -s "202.87.39.93:25"

else
    echo "0 Postgres_Replication_Lag - OK: Replication lag is $replication_lag_minutes minutes|replication_lag=$replication_lag_minutes"
fi
